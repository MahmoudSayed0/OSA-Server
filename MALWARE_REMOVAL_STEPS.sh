#!/bin/bash
# EMERGENCY MALWARE REMOVAL SCRIPT FOR VPS
# Run this on your VPS: ssh root@31.97.35.144

echo "=== EMERGENCY MALWARE REMOVAL ==="
echo "Target: system3d cryptominer"

# 1. Find and kill the malicious processes
echo "[1] Killing system3d processes..."
pkill -9 system3d
killall -9 system3d

# 2. Find where it's located
echo "[2] Finding system3d location..."
find / -name "system3d" -type f 2>/dev/null
find / -name "*system3d*" 2>/dev/null

# 3. Common malware locations to check
echo "[3] Checking common malware locations..."
ls -la /tmp/
ls -la /var/tmp/
ls -la /dev/shm/
ls -la ~/.ssh/
ls -la /root/.ssh/
ls -la /home/*/

# 4. Remove the malware
echo "[4] Removing system3d (UPDATE PATHS AS FOUND ABOVE)..."
# After running step 2, manually remove with:
# rm -f /path/to/system3d

# 5. Check and clean cron jobs
echo "[5] Checking cron jobs for persistence..."
crontab -l
cat /etc/crontab
ls -la /etc/cron.d/
ls -la /etc/cron.hourly/
ls -la /var/spool/cron/crontabs/

# 6. Check systemd services
echo "[6] Checking systemd services..."
systemctl list-units --type=service --state=running | grep -v "@"
ls -la /etc/systemd/system/ | grep -i system3d
ls -la /lib/systemd/system/ | grep -i system3d

# 7. Check for autostart scripts
echo "[7] Checking autostart scripts..."
cat /etc/rc.local
ls -la /etc/rc*.d/

# 8. Check network connections
echo "[8] Checking network connections..."
netstat -tunlp | grep system3d
ss -tulpn | grep system3d

# 9. Full system scan
echo "[9] Installing and running malware scanner..."
apt update
apt install -y clamav clamav-daemon rkhunter chkrootkit

systemctl stop clamav-freshclam
freshclam
systemctl start clamav-freshclam

# Scan critical directories
clamscan -r -i --log=/root/malware-scan.log /tmp /var/tmp /root /home /usr/local

# 10. Check for rootkits
echo "[10] Scanning for rootkits..."
rkhunter --update
rkhunter --check --skip-keypress --report-warnings-only

chkrootkit

echo ""
echo "=== SCAN COMPLETE ==="
echo "Review logs:"
echo "  - Malware scan: cat /root/malware-scan.log"
echo "  - Rootkit scan: cat /var/log/rkhunter.log"
echo ""
echo "NEXT STEPS:"
echo "1. Delete any files found by the scans"
echo "2. Remove any malicious cron jobs"
echo "3. Change all passwords"
echo "4. Review SSH authorized_keys"
echo "5. Check Docker containers for compromise"
